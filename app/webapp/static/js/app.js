// Generated by CoffeeScript 1.6.3
(function() {
  var APP_NAME, DIRECTIVE_MODULE, SERVICE_MODULE, app;

  APP_NAME = 'lintblame';

  DIRECTIVE_MODULE = "" + APP_NAME + ".directives";

  SERVICE_MODULE = "" + APP_NAME + ".services";

  angular.module(DIRECTIVE_MODULE, []);

  angular.module(SERVICE_MODULE, []);

  angular.module(SERVICE_MODULE).service('Api', function($q, $http, $rootScope) {
    var Api;
    Api = (function() {
      function Api() {}

      Api.prototype.lastUpdate = null;

      Api.prototype.scan = function() {
        return 'blah';
      };

      Api.prototype.testPath = function(path, branchMode) {
        var config, deferred, request;
        if (branchMode == null) {
          branchMode = false;
        }
        $rootScope.setLoading(true);
        deferred = $q.defer();
        config = {
          url: "/api/testpath",
          params: {
            path: path
          },
          method: 'get',
          cache: false
        };
        if (branchMode) {
          console.log('branchMode:', branchMode);
          config.params.branch = branchMode;
        }
        request = $http(config);
        request.success(function(response) {
          deferred.resolve(response);
          return $rootScope.setLoading(false);
        });
        return deferred.promise;
      };

      Api.prototype.fullScan = function(paths) {
        var deferred, pathsParam, request;
        $rootScope.setLoading(true);
        this.lastUpdate = Date.now();
        deferred = $q.defer();
        pathsParam = paths.join(',');
        request = $http({
          url: "/api/fullscan",
          params: {
            paths: pathsParam
          },
          method: 'get',
          cache: false
        });
        request.success(function(response) {
          deferred.resolve(response);
          return $rootScope.setLoading(false);
        });
        return deferred.promise;
      };

      Api.prototype.poll = function(paths, branchMode) {
        var deferred, request,
          _this = this;
        if (branchMode == null) {
          branchMode = false;
        }
        deferred = $q.defer();
        request = $http({
          url: '/api/poll',
          method: 'get',
          params: {
            since: this.lastUpdate,
            paths: paths.join(','),
            branch: branchMode
          },
          cache: false
        });
        request.success(function(response) {
          if (!_.isEmpty(response)) {
            _this.lastUpdate = Date.now();
          }
          return deferred.resolve(response);
        });
        return deferred.promise;
      };

      return Api;

    })();
    return new Api();
  });

  angular.module(SERVICE_MODULE).service('Lints', function($rootScope) {
    var Lints;
    Lints = (function() {
      function Lints() {}

      Lints.prototype.issueCount = function(lintData) {
        return lintData.issues.length;
      };

      return Lints;

    })();
    return new Lints();
  });

  angular.module(SERVICE_MODULE).service('LocalStorage', function(SavedTarget) {
    var LocalStorage;
    LocalStorage = (function() {
      function LocalStorage() {}

      LocalStorage.prototype.STORAGE_KEY = 'lintblame';

      LocalStorage.prototype.SAVED_TARGETS_KEY = 'saves';

      LocalStorage.prototype.listeners = [];

      LocalStorage.prototype.set = function(val) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(val));
        return _.each(this.listeners, function(listener) {
          return listener();
        });
      };

      LocalStorage.prototype.setAttr = function(key, val) {
        var all;
        all = this.get();
        all[key] = val;
        return this.set(all);
      };

      LocalStorage.prototype.get = function(key) {
        var all;
        if (key == null) {
          key = null;
        }
        all = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
        if (!key) {
          return all;
        }
        return all[key];
      };

      LocalStorage.prototype.savedLintTargets = function() {
        return this.get(this.SAVED_TARGETS_KEY);
      };

      LocalStorage.prototype.updateSavedLintTargets = function(saved) {
        return this.setAttr(this.SAVED_TARGETS_KEY, saved);
      };

      LocalStorage.prototype.saveLintTarget = function(saveTarget) {
        var currentSaved, path;
        currentSaved = this.get(this.SAVED_TARGETS_KEY);
        path = saveTarget.path;
        if (!path) {
          throw "Bad path: " + path;
        }
        saveTarget.setUpdated();
        currentSaved[path] = saveTarget.toObj();
        return this.updateSavedLintTargets(currentSaved);
      };

      LocalStorage.prototype.getSavedLintTarget = function(path) {
        var saved, target;
        saved = this.savedLintTargets();
        if (_.has(saved, path)) {
          target = new SavedTarget(saved[path]);
          return target;
        }
        throw "" + path + " is not saved!";
      };

      LocalStorage.prototype.setSaveName = function(path, name) {
        var target;
        target = this.getSavedLintTarget(path);
        target.saveName = name;
        return this.saveLintTarget(target);
      };

      LocalStorage.prototype.deleteSave = function(path) {
        var saved;
        saved = this.savedLintTargets();
        if (_.has(saved, path)) {
          delete saved[path];
        }
        return this.updateSavedLintTargets(saved);
      };

      LocalStorage.prototype.resetAppStorage = function() {
        var defaultState;
        console.log('resetting app storage');
        defaultState = {};
        defaultState[this.SAVED_TARGETS_KEY] = {};
        return this.set(defaultState);
      };

      LocalStorage.prototype.initIfNecessary = function() {
        if (!this.get()) {
          return this.resetAppStorage();
        }
      };

      LocalStorage.prototype.addListener = function(listener) {
        return this.listeners.push(listener);
      };

      return LocalStorage;

    })();
    return new LocalStorage();
  });

  angular.module(SERVICE_MODULE).service('SavedTarget', function() {
    var SavedTarget;
    SavedTarget = (function() {
      function SavedTarget(properties) {
        var defaults,
          _this = this;
        defaults = {
          branchMode: false
        };
        properties = _.extend(defaults, properties);
        _.each(properties, function(val, key) {
          return _this[key] = val;
        });
      }

      SavedTarget.prototype.toObj = function() {
        return {
          path: this.path,
          branchMode: this.branchMode,
          updated: this.updated,
          saveName: this.saveName
        };
      };

      SavedTarget.prototype.setUpdated = function() {
        return this.updated = Date.now();
      };

      return SavedTarget;

    })();
    return SavedTarget;
  });

  angular.module(DIRECTIVE_MODULE).directive('lintIssues', function($rootScope) {
    var directive;
    return directive = {
      replace: true,
      template: "<div class=\"lint-issues\" ng-class=\"{demoted: demotions[path]}\">\n    <div class=\"path\">\n        <span class=\"label {{countClass}}\">{{totalCount}}</span>\n            &nbsp;\n        <span class=\"dim\">{{pathParts[0]}}/</span><strong>{{pathParts[1]}}</strong>\n\n        <div class=\"pull-right\">\n            <a ng-click=\"demote(path)\">\n                <span ng-show=\"!demotions[path]\"\n                    class=\"glyphicon glyphicon-thumbs-down dim hover-bright\">\n                </span>\n                <span ng-show=\"demotions[path]\"\n                    class=\"glyphicon glyphicon-thumbs-up dim hover-bright\">\n                </span>\n            </a>\n        </div>\n    </div>\n    <div ng-repeat=\"line in sortedLines\" class=\"line-wrapper\" ng-show=\"!demotions[path]\">\n        <div class=\"line\">\n            {{line}}\n        </div>\n        <div class=\"detail\">\n            <code class=\"code\">\n                {{data.lines[line - 1]}}\n            </code>\n            <table>\n                <tr ng-repeat=\"issue in issuesByLine[line]\" class=\"issue\">\n                    <td class=\"reporter\">\n                        {{issue.reporter}}\n                        {{issue.code}}\n                    </td>\n                    <td class=\"{{blameClass(line)}}\">\n                        [{{blameLine(issue.line)}}]\n                    </td>\n                    <td>\n                        {{issue.message}}\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n</div>",
      link: function(scope) {
        scope.update = function() {
          var issue, issuesByLine, line, lineInts, pathParts, totalCount, _i, _len, _ref;
          if (!_.has(scope.lintResults, scope.path)) {
            return;
          }
          scope.data = scope.lintResults[scope.path];
          issuesByLine = {};
          totalCount = 0;
          _ref = scope.data.issues;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            issue = _ref[_i];
            line = issue.line;
            if (!_.has(issuesByLine, line)) {
              issuesByLine[line] = [];
            }
            issuesByLine[line].push(issue);
            totalCount += 1;
          }
          scope.issuesByLine = issuesByLine;
          scope.totalCount = totalCount;
          if (totalCount) {
            scope.countClass = 'label-warning';
          } else {
            scope.countClass = 'label-success';
          }
          lineInts = _.map(issuesByLine, function(issue, line) {
            return parseInt(line, 10);
          });
          scope.sortedLines = lineInts.sort(function(a, b) {
            return a - b;
          });
          pathParts = scope.path.split('/');
          scope.pathParts = [];
          if (pathParts.length > 1) {
            scope.pathParts.push(pathParts.slice(0, pathParts.length - 1).join('/'));
          } else {
            scope.pathParts.push('');
          }
          return scope.pathParts.push(pathParts[pathParts.length - 1]);
        };
        scope.blameLine = function(line) {
          return scope.data.blame[line - 1];
        };
        scope.blameClass = function(line) {
          var cls, lineBlame;
          cls = 'blame';
          lineBlame = scope.blameLine(line);
          if (lineBlame === $rootScope.vcsName || lineBlame === 'Not Committed Yet') {
            cls += ' blame-me';
          }
          return cls;
        };
        scope.$watch('lastRefresh', function() {
          return scope.update();
        });
        return scope.demote = function(path) {
          return scope.$emit('demote', path);
        };
      }
    };
  });

  angular.module(DIRECTIVE_MODULE).directive('savedTarget', function($rootScope, LocalStorage) {
    var directive;
    return directive = {
      replace: true,
      template: "<div class=\"saved-target\">\n    <input type=\"text\"\n        class=\"form-control code\"\n        ng-model=\"m.saveName\"\n        ng-change=\"saveNameChange()\"\n        placeholder=\"Save Name\">\n\n    <div class=\"dim tiny save-details\">\n        {{m.path}}\n        <div class=\"pull-right\">\n            <span class=\"label label-primary\" ng-show=\"data.branchMode\">B</span>\n        </div>\n    </div>\n    <div class=\"small actions\">\n        <a class=\"danger\" ng-click=\"deleteSave()\">\n            <span class=\"glyphicon glyphicon-remove-circle\"></span>\n        </a>\n        <div class=\"pull-right\">\n            <a ng-click=\"loadSavePath(path)\">Load</a>\n        </div>\n    </div>\n</div>",
      link: function(scope) {
        var frag;
        scope.m = {
          path: scope.path
        };
        if (scope.path.length > 20) {
          frag = scope.path.substr(17);
          scope.m.path = "..." + frag;
        }
        if (_.has(scope.data, 'saveName')) {
          scope.m.saveName = scope.data.saveName;
        }
        scope.saveNameChange = function() {
          return LocalStorage.setSaveName(scope.path, scope.m.saveName);
        };
        return scope.deleteSave = function() {
          return LocalStorage.deleteSave(scope.path);
        };
      }
    };
  });

  angular.module(DIRECTIVE_MODULE).directive('userFeedback', function() {
    var directive;
    return directive = {
      template: "<div class=\"row-fluid\" ng-show=\"fbModel.html\">\n    <div class=\"span12 alert {{fbModel.alertClass}}\">\n        <span class=\"{{fbModel.iconClass}}\" ng-show=\"fbModel.iconClass\"></span>\n        <span ng-bind-html-unsafe=\"fbModel.html\"></span>\n    </div>\n</div>",
      link: function(scope) {
        var setFeedback;
        scope.fbModel = {};
        setFeedback = function(html, alertClass, iconClass) {
          scope.fbModel.html = html;
          scope.fbModel.alertClass = alertClass;
          return scope.fbModel.iconClass = iconClass;
        };
        scope.$on('feedback', function(html, alertClass, iconClass) {
          return setFeedback(html, alertClass, iconClass);
        });
        scope.$on('successFeedback', function(e, html) {
          return setFeedback(html, 'alert-success', 'icon-thumbs-up');
        });
        scope.$on('errorFeedback', function(e, html) {
          return setFeedback(html, 'alert-error', 'icon-exclamation-sign');
        });
        scope.$on('warnFeedback', function(e, html) {
          return setFeedback(html, '', 'icon-info-sign');
        });
        return scope.$on('clearFeedback', function(e) {
          return setFeedback(null, '', '');
        });
      }
    };
  });

  app = angular.module(APP_NAME, ["" + APP_NAME + ".services", "" + APP_NAME + ".directives"]).run(function($rootScope, Api, Lints, LocalStorage) {
    var spinOpts, updateFavicon;
    $rootScope.appName = "lintblame";
    $rootScope.lintResults = {};
    LocalStorage.initIfNecessary();
    spinOpts = {
      lines: 10,
      length: 5,
      width: 2,
      radius: 5,
      corners: 1,
      rotate: 0,
      direction: 1,
      color: '#fff',
      speed: 1,
      trail: 60,
      shadow: false,
      hwaccel: false,
      className: 'spinner',
      zIndex: 2e9,
      top: '0',
      left: '0'
    };
    $rootScope.loadingSpinner = new Spinner(spinOpts);
    $rootScope.isSpinning = false;
    $rootScope.setLoading = function(val) {
      var target;
      if (val) {
        if (!$rootScope.isSpinning) {
          target = document.getElementById('loading');
          return $rootScope.loadingSpinner.spin(target);
        }
      } else {
        return $rootScope.loadingSpinner.stop();
      }
    };
    $rootScope.activePaths = function() {
      if (!$rootScope.lintResults) {
        return [];
      }
      return _.keys($rootScope.lintResults);
    };
    updateFavicon = function() {
      var count, data, path, _ref, _results;
      count = 0;
      _ref = $rootScope.lintResults;
      _results = [];
      for (path in _ref) {
        data = _ref[path];
        _results.push(count += Lints.issueCount(data));
      }
      return _results;
    };
    $rootScope.updateResults = function(pathsAndData) {
      var data, lastRefresh, mins, now, path, paths, secs;
      for (path in pathsAndData) {
        data = pathsAndData[path];
        Lints.issueCount(data);
        $rootScope.lintResults[path] = data;
      }
      paths = _.keys($rootScope.lintResults);
      $rootScope.sortedPaths = paths.sort(function(a, b) {
        return Lints.issueCount($rootScope.lintResults[b]) - Lints.issueCount($rootScope.lintResults[a]);
      });
      now = new Date();
      lastRefresh = now.getHours() + ':';
      mins = now.getMinutes();
      if (mins < 10) {
        lastRefresh += '0';
      }
      lastRefresh += mins + ':';
      secs = now.getSeconds();
      if (secs < 10) {
        lastRefresh += '0';
      }
      lastRefresh += secs;
      return $rootScope.lastRefresh = lastRefresh;
    };
    $rootScope.deletePath = function(path) {
      return delete $rootScope.lintResults[path];
    };
    return $rootScope.loadSavePath = function(path) {
      return $rootScope.loadedSavePath = path;
    };
  });

  angular.module(APP_NAME).controller('MenuCtrl', function($scope, $rootScope, $q, Api, LocalStorage, SavedTarget) {
    var loadSave, stopPolling, targetPathChange, testPath, updatePaths;
    $rootScope.branchMode = false;
    $scope.showSubmitBtn = true;
    $scope.isPolling = false;
    $scope.pollCount = 0;
    $scope.acceptedPath = null;
    $scope.pendingPaths = [];
    testPath = function(andAccept) {
      var deferred, path;
      if (andAccept == null) {
        andAccept = false;
      }
      deferred = $q.defer();
      path = $scope.targetPathInput;
      Api.testPath(path, $rootScope.branchMode).then(function(response) {
        $scope.pathExists = response.exists;
        $scope.targets = response.targets;
        if (!_.isUndefined(response.vcs)) {
          $scope.vcs = response.vcs;
          $scope.branch = response.branch;
          $rootScope.vcsName = response.name;
        }
        if (andAccept) {
          $scope.acceptPath();
        }
        return deferred.resolve();
      });
      return deferred.promise;
    };
    updatePaths = function() {
      if (!$scope.acceptedPath) {
        return;
      }
      return Api.testPath($scope.acceptedPath, $rootScope.branchMode).then(function(response) {
        var newPaths;
        newPaths = _.without(response.targets, $rootScope.activePaths());
        console.log('newPaths:', newPaths, $scope.pendingPaths);
        $scope.pendingPaths = newPaths;
        if ($scope.pendingPaths) {
          return console.log('$scope.pendingPaths:', $scope.pendingPaths);
        }
      });
    };
    stopPolling = function() {
      if ($scope.pollInterval) {
        clearInterval($scope.pollInterval);
      }
      return $scope.isPolling = false;
    };
    $scope.poll = function() {
      stopPolling();
      $scope.pollInterval = setInterval(function() {
        var paths;
        paths = $rootScope.activePaths();
        if (paths.length > 0) {
          Api.poll(paths, $rootScope.branchMode).then(function(response) {
            var p, _i, _len, _ref, _results;
            if (!_.isEmpty(response)) {
              $rootScope.updateResults(response.changed);
              if (_.has(response, 'delete')) {
                _ref = response["delete"];
                _results = [];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  p = _ref[_i];
                  _results.push($rootScope.deletePath(p));
                }
                return _results;
              }
            }
          });
          return $scope.pollCount += 1;
        }
      }, 2000);
      return $scope.isPolling = true;
    };
    $scope.togglePolling = function() {
      if ($scope.isPolling) {
        return stopPolling();
      } else {
        return $scope.poll();
      }
    };
    $scope.acceptPath = function() {
      if (!$scope.targets || $scope.targets.length === 0) {
        console.log('here');
        return;
      }
      $scope.showSubmitBtn = false;
      $scope.showSaveBtn = true;
      $scope.acceptedPath = $scope.targetPathInput;
      return Api.fullScan($scope.targets).then(function(response) {
        $rootScope.updateResults(response);
        return $scope.poll();
      });
    };
    targetPathChange = function() {
      var path;
      stopPolling();
      $rootScope.branchMode = false;
      path = $scope.targetPathInput;
      if (path) {
        $scope.showSubmitBtn = true;
        return testPath();
      }
    };
    $scope.targetPathChange = _.throttle(targetPathChange, 1000);
    $scope.toggleBranchMode = function() {
      $rootScope.branchMode = !$rootScope.branchMode;
      return testPath(true);
    };
    $scope.saveState = function() {
      var saved;
      saved = new SavedTarget({
        path: $scope.acceptedPath,
        branchMode: true
      });
      LocalStorage.saveLintTarget(saved);
      return $scope.showSaveBtn = false;
    };
    loadSave = function(path) {
      var save;
      if (!path) {
        return;
      }
      save = LocalStorage.getSavedLintTarget(path);
      $rootScope.branchMode = save.branchMode;
      $scope.targetPathInput = path;
      return testPath(true);
    };
    return $scope.$watch('loadedSavePath', function() {
      return loadSave($rootScope.loadedSavePath);
    });
  });

  angular.module(APP_NAME).controller('ResultsCtrl', function($scope, $rootScope, $interval, Api) {
    $scope.demotions = {};
    return $scope.$on('demote', function(e, path) {
      if (!_.has($scope.demotions, path)) {
        return $scope.demotions[path] = true;
      } else {
        return $scope.demotions[path] = !$scope.demotions[path];
      }
    });
  });

  angular.module(APP_NAME).controller('SavesCtrl', function($scope, $rootScope, LocalStorage) {
    var update;
    update = function() {
      return $scope.saves = LocalStorage.savedLintTargets();
    };
    update();
    return LocalStorage.addListener(function() {
      return update();
    });
  });

}).call(this);
